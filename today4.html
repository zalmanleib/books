<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Morah Shiur — Rambam Daily</title>
  <style>
    body {
      margin:0;
      font-family:sans-serif;
      background:#0f172a;
      color:#f5f5f5;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
    }
    .container {
      max-width:900px;
      width:100%;
      background:#1e293b;
      border-radius:10px;
      padding:16px;
      box-shadow:0 6px 20px rgba(0,0,0,0.5);
    }
    header h1 {
      margin:0 0 10px;
      text-align:center;
    }
    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
      justify-content:center;
    }
    input,button {
      padding:6px 10px;
      border-radius:6px;
      border:none;
    }
    input {
      background:#334155;
      color:#f5f5f5;
    }
    button {
      cursor:pointer;
      background:#4c1d95;
      color:white;
    }
    iframe {
      width:100%;
      height:600px;
      border:0;
      border-radius:6px;
      background:white;
      display:none;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Morah Shiur — Rambam Daily</h1>
  </header>

  <div class="controls">
    <label>Date: <input type="date" id="pickDate"></label>
    <button id="cycle1">Perek Echad</button>
    <button id="cycle3">Shlosha Perakim</button>
    <button id="prevBtn">← Prev</button>
    <button id="todayBtn">Today</button>
    <button id="nextBtn">Next →</button>
    <button id="viewerBtn">Change Viewer</button>
    <button id="openTabBtn">Open Fullscreen</button>
  </div>

  <iframe id="pdfFrame"></iframe>
</div>

<script>
  // Start dates
  const startDateEchod = new Date("1984-04-28");
  const startDateShlosha = new Date("1984-04-28");

  // Cycle data
  const cycles = {
    echod: { base:"https://s3.amazonaws.com/DvarMalchus/rambam/1/", max:1017, start:startDateEchod },
    shlosha: { base:"https://s3.amazonaws.com/DvarMalchus/rambam/3/", max:339, start:startDateShlosha }
  };

  let currentCycle = null;
  let currentDate = new Date();
  let viewerMode = 0; // 0=regular, 1=Google Drive, 2=PDF.js

  const pdfFrame = document.getElementById("pdfFrame");
  const pickDate = document.getElementById("pickDate");

  // Format date to yyyy-mm-dd
  function formatDate(d) {
    return d.toISOString().split("T")[0];
  }

  // Set date picker to today initially
  pickDate.value = formatDate(currentDate);

  function getCycleDay(startDate, date, maxDays) {
    const diffTime = date - startDate;
    const diffDays = Math.floor(diffTime / (1000*60*60*24));
    return (diffDays % maxDays) + 1;
  }

  function buildUrl(cycle, date) {
    const day = getCycleDay(cycle.start, date, cycle.max);
    const fileUrl = cycle.base + day + ".pdf";
    if (viewerMode === 1) {
      return "https://docs.google.com/gview?embedded=true&url=" + encodeURIComponent(fileUrl);
    } else if (viewerMode === 2) {
      return "https://mozilla.github.io/pdf.js/web/viewer.html?file=" + encodeURIComponent(fileUrl);
    } else {
      return fileUrl;
    }
  }

  function updatePdf() {
    if (!currentCycle) return;
    pickDate.value = formatDate(currentDate); // keep picker synced
    const url = buildUrl(cycles[currentCycle], currentDate);
    pdfFrame.src = url;
    pdfFrame.style.display = "block";
    document.getElementById("openTabBtn").onclick = () => window.open(url, "_blank");
  }

  // Event listeners
  document.getElementById("cycle1").onclick = () => { currentCycle="echod"; currentDate=new Date(); updatePdf(); };
  document.getElementById("cycle3").onclick = () => { currentCycle="shlosha"; currentDate=new Date(); updatePdf(); };

  document.getElementById("prevBtn").onclick = () => { if (currentCycle){ currentDate.setDate(currentDate.getDate()-1); updatePdf(); } };
  document.getElementById("nextBtn").onclick = () => { if (currentCycle){ currentDate.setDate(currentDate.getDate()+1); updatePdf(); } };
  document.getElementById("todayBtn").onclick = () => { if (currentCycle){ currentDate=new Date(); updatePdf(); } };

  pickDate.onchange = () => { if (currentCycle){ currentDate=new Date(pickDate.value); updatePdf(); } };

  document.getElementById("viewerBtn").onclick = () => {
    viewerMode = (viewerMode+1)%3;
    updatePdf();
  };
</script>
</body>
</html>
